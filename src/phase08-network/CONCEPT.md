# 网络与安全深入解析

## 📌 一、HTTP 协议

### 1. HTTP 请求结构

```
┌─────────────────────────────────────────────────────────────┐
│                       HTTP 请求                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  请求行:                                                     │
│  GET /path/to/resource HTTP/1.1                             │
│                                                             │
│  请求头:                                                     │
│  Host: example.com                                          │
│  User-Agent: Mozilla/5.0                                    │
│  Accept: text/html                                          │
│  Content-Type: application/json                             │
│  Cookie: session=abc123                                     │
│                                                             │
│  空行                                                        │
│                                                             │
│  请求体:                                                     │
│  {"name": "Alice", "age": 20}                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2. HTTP 响应结构

```
┌─────────────────────────────────────────────────────────────┐
│                       HTTP 响应                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  状态行:                                                     │
│  HTTP/1.1 200 OK                                            │
│                                                             │
│  响应头:                                                     │
│  Content-Type: application/json                             │
│  Content-Length: 1234                                       │
│  Set-Cookie: session=abc123                                 │
│  Cache-Control: max-age=3600                                │
│                                                             │
│  空行                                                        │
│                                                             │
│  响应体:                                                     │
│  {"status": "success", "data": {...}}                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3. HTTP 方法

```
┌─────────────┬────────────────────────────────────────────────┐
│    方法      │                    用途                        │
├─────────────┼────────────────────────────────────────────────┤
│ GET         │ 获取资源                                        │
│ POST        │ 提交数据 (创建资源)                              │
│ PUT         │ 更新资源 (完整替换)                              │
│ PATCH       │ 更新资源 (部分更新)                              │
│ DELETE      │ 删除资源                                        │
│ HEAD        │ 获取响应头 (不返回 body)                         │
│ OPTIONS     │ 预检请求 (CORS)                                 │
└─────────────┴────────────────────────────────────────────────┘
```

### 4. HTTP 状态码

```
┌─────────────┬────────────────────────────────────────────────┐
│   状态码     │                    含义                        │
├─────────────┼────────────────────────────────────────────────┤
│ 1xx         │ 信息性响应                                      │
├─────────────┼────────────────────────────────────────────────┤
│ 200 OK      │ 请求成功                                        │
│ 201 Created │ 创建成功                                        │
│ 204 No Content │ 成功但无内容                                 │
├─────────────┼────────────────────────────────────────────────┤
│ 301         │ 永久重定向 (SEO 权重转移)                        │
│ 302         │ 临时重定向                                      │
│ 304         │ 未修改 (使用缓存)                                │
├─────────────┼────────────────────────────────────────────────┤
│ 400         │ 请求参数错误                                    │
│ 401         │ 未认证                                          │
│ 403         │ 无权限                                          │
│ 404         │ 资源不存在                                      │
│ 405         │ 方法不允许                                      │
│ 429         │ 请求过多 (限流)                                  │
├─────────────┼────────────────────────────────────────────────┤
│ 500         │ 服务器内部错误                                   │
│ 502         │ 网关错误                                        │
│ 503         │ 服务不可用                                      │
│ 504         │ 网关超时                                        │
└─────────────┴────────────────────────────────────────────────┘
```

---

## 📌 二、HTTPS

### 1. HTTPS 握手过程

```
┌─────────┐                                    ┌─────────┐
│ Client  │                                    │ Server  │
└────┬────┘                                    └────┬────┘
     │                                              │
     │  ─────── Client Hello ──────────────────→   │
     │  (支持的加密套件、随机数 Client Random)       │
     │                                              │
     │  ←────── Server Hello ──────────────────    │
     │  (选择的加密套件、随机数 Server Random)       │
     │                                              │
     │  ←────── Certificate ───────────────────    │
     │  (服务器证书)                                │
     │                                              │
     │  ←────── Server Hello Done ─────────────    │
     │                                              │
     │  ─────── Client Key Exchange ───────────→   │
     │  (预主密钥 Pre-Master Secret)                │
     │                                              │
     │  ─────── Change Cipher Spec ────────────→   │
     │  ─────── Finished ──────────────────────→   │
     │                                              │
     │  ←────── Change Cipher Spec ────────────    │
     │  ←────── Finished ──────────────────────    │
     │                                              │
     │  ═══════ 加密通信开始 ═══════════════════    │
     │                                              │
```

### 2. 证书验证

```
证书链验证:
服务器证书 → 中间证书 → 根证书 (浏览器内置)

验证内容:
1. 证书是否过期
2. 证书域名是否匹配
3. 证书签名是否有效
4. 证书是否被吊销
```

---

## 📌 三、缓存机制

### 1. 缓存流程

```
                    ┌───────────────┐
                    │   发起请求    │
                    └───────┬───────┘
                            ↓
                    ┌───────────────┐
               ┌─── │  有缓存？     │ ───┐
               │    └───────────────┘    │
              是                         否
               ↓                          ↓
      ┌───────────────┐          ┌───────────────┐
      │  缓存是否过期？│          │   请求服务器   │
      └───────┬───────┘          └───────────────┘
         ┌────┴────┐
        否         是
         ↓          ↓
  ┌──────────┐  ┌───────────────┐
  │ 使用缓存 │  │ 协商缓存验证   │
  │ (强缓存) │  └───────┬───────┘
  └──────────┘     ┌────┴────┐
                  304        200
                   ↓          ↓
            ┌──────────┐  ┌──────────┐
            │ 使用缓存 │  │ 新资源   │
            └──────────┘  └──────────┘
```

### 2. 强缓存

```
响应头:
Cache-Control: max-age=31536000    // 缓存有效期(秒)
Cache-Control: no-cache            // 每次都要协商
Cache-Control: no-store            // 不缓存
Cache-Control: private             // 仅浏览器缓存
Cache-Control: public              // 可被 CDN 缓存

Expires: Wed, 21 Oct 2025 07:28:00 GMT  // 过期时间(已废弃)

优先级: Cache-Control > Expires
```

### 3. 协商缓存

```
第一次请求:
响应头:
  ETag: "abc123"                    // 资源唯一标识
  Last-Modified: Wed, 21 Oct 2024  // 最后修改时间

再次请求:
请求头:
  If-None-Match: "abc123"
  If-Modified-Since: Wed, 21 Oct 2024

服务器响应:
  304 Not Modified  → 使用缓存
  200 OK + 新内容   → 更新缓存

优先级: ETag > Last-Modified
```

### 4. 缓存策略实践

```
┌─────────────────────┬────────────────────────────────────┐
│      资源类型        │           缓存策略                 │
├─────────────────────┼────────────────────────────────────┤
│ HTML                │ Cache-Control: no-cache            │
│ (入口文件)          │ (每次协商验证)                      │
├─────────────────────┼────────────────────────────────────┤
│ JS/CSS              │ Cache-Control: max-age=31536000    │
│ (带 hash 的静态资源) │ (一年强缓存，通过文件名更新)        │
├─────────────────────┼────────────────────────────────────┤
│ 图片/字体           │ Cache-Control: max-age=31536000    │
├─────────────────────┼────────────────────────────────────┤
│ API 响应            │ Cache-Control: no-store            │
│                     │ 或动态设置                          │
└─────────────────────┴────────────────────────────────────┘
```

---

## 📌 四、HTTP/2 与 HTTP/3

### 1. HTTP/1.1 的问题

```
1. 队头阻塞: 一个请求阻塞后续请求
2. 无法并行: 每个连接只能处理一个请求
3. 头部冗余: 每次请求都要发送完整头部
4. 无服务器推送
```

### 2. HTTP/2 特性

```
┌─────────────────────────────────────────────────────────────┐
│                       HTTP/2 特性                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 二进制分帧                                               │
│     请求/响应被分割成多个帧，可以乱序发送                     │
│                                                             │
│  2. 多路复用                                                 │
│     一个连接上并行多个请求/响应                              │
│                                                             │
│  3. 头部压缩 (HPACK)                                         │
│     静态表 + 动态表 + 哈夫曼编码                             │
│                                                             │
│  4. 服务器推送                                               │
│     服务器主动推送资源                                       │
│                                                             │
│  5. 请求优先级                                               │
│     客户端可以指定资源优先级                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3. HTTP/3 (QUIC)

```
┌─────────────────────────────────────────────────────────────┐
│                       HTTP/3 特性                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  基于 QUIC 协议 (UDP)                                        │
│                                                             │
│  1. 0-RTT 连接建立                                          │
│     首次 1-RTT，后续 0-RTT                                   │
│                                                             │
│  2. 解决 TCP 队头阻塞                                        │
│     流级别的独立传输                                         │
│                                                             │
│  3. 连接迁移                                                 │
│     网络切换时连接不中断                                     │
│                                                             │
│  4. 改进的拥塞控制                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 📌 五、XSS 攻击与防护

### 1. XSS 类型

```
┌─────────────────┬────────────────────────────────────────────┐
│     类型         │                  说明                      │
├─────────────────┼────────────────────────────────────────────┤
│ 存储型 XSS      │ 恶意脚本存储在服务器，所有用户访问时执行     │
│ (Stored)        │ 例：评论区注入脚本                          │
├─────────────────┼────────────────────────────────────────────┤
│ 反射型 XSS      │ 恶意脚本在 URL 中，服务器返回时执行          │
│ (Reflected)     │ 例：搜索结果显示用户输入                     │
├─────────────────┼────────────────────────────────────────────┤
│ DOM 型 XSS      │ 纯前端，恶意脚本修改 DOM                     │
│ (DOM-based)     │ 例：innerHTML 直接插入用户输入               │
└─────────────────┴────────────────────────────────────────────┘
```

### 2. XSS 防护

```javascript
// 1. 输出编码
function escapeHtml(str) {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;');
}

// 2. 使用 textContent 而非 innerHTML
element.textContent = userInput;  // ✅ 安全
element.innerHTML = userInput;    // ❌ 危险

// 3. CSP (Content Security Policy)
// HTTP 响应头:
Content-Security-Policy: default-src 'self'; script-src 'self' https://trusted.com

// 4. Cookie 设置 HttpOnly
Set-Cookie: session=abc; HttpOnly; Secure; SameSite=Strict

// 5. 使用框架的自动转义
// React JSX 自动转义
<div>{userInput}</div>  // 安全
<div dangerouslySetInnerHTML={{ __html: userInput }} />  // 危险
```

---

## 📌 六、CSRF 攻击与防护

### 1. CSRF 原理

```
┌─────────┐         ┌─────────┐         ┌─────────┐
│  用户   │         │ 恶意网站 │         │ 目标网站 │
└────┬────┘         └────┬────┘         └────┬────┘
     │                   │                   │
     │  1. 登录目标网站，获取 Cookie           │
     │  ─────────────────────────────────────→│
     │                   │                   │
     │  2. 访问恶意网站                        │
     │  ─────────────────→                    │
     │                   │                   │
     │  ←──── 3. 恶意网站返回包含             │
     │        自动提交表单的页面               │
     │                   │                   │
     │  4. 自动向目标网站发起请求             │
     │     (携带用户 Cookie)                  │
     │  ─────────────────────────────────────→│
     │                   │                   │
```

### 2. CSRF 防护

```javascript
// 1. CSRF Token
// 服务端生成 token，嵌入表单
<input type="hidden" name="_csrf" value="random-token">

// 请求时验证 token

// 2. SameSite Cookie
Set-Cookie: session=abc; SameSite=Strict  // 最严格
Set-Cookie: session=abc; SameSite=Lax     // 允许导航跳转

// 3. 验证 Origin / Referer 头
if (req.headers.origin !== 'https://mysite.com') {
  throw new Error('Invalid origin');
}

// 4. 二次确认
// 敏感操作要求输入密码或验证码
```

---

## 📌 七、CORS 跨域

### 1. 同源策略

```
同源 = 协议 + 域名 + 端口 都相同

http://example.com/a
http://example.com/b       ✅ 同源
https://example.com/a      ❌ 协议不同
http://api.example.com/a   ❌ 域名不同
http://example.com:8080/a  ❌ 端口不同
```

### 2. CORS 流程

```
简单请求:
  请求 → 响应 (带 CORS 头)

预检请求 (复杂请求):
  OPTIONS 请求 → 响应 → 实际请求 → 响应

预检触发条件:
  • 方法: PUT, DELETE, PATCH
  • 自定义请求头
  • Content-Type 非 form-data, urlencoded, text/plain
```

### 3. CORS 响应头

```
// 允许的源
Access-Control-Allow-Origin: https://example.com
Access-Control-Allow-Origin: *

// 允许的方法
Access-Control-Allow-Methods: GET, POST, PUT, DELETE

// 允许的请求头
Access-Control-Allow-Headers: Content-Type, Authorization

// 允许携带凭证
Access-Control-Allow-Credentials: true

// 预检请求缓存时间
Access-Control-Max-Age: 86400

// 允许前端访问的响应头
Access-Control-Expose-Headers: X-Custom-Header
```

### 4. 前端配置

```javascript
// fetch
fetch("https://api.example.com/data", {
  method: "POST",
  credentials: "include", // 携带 Cookie
  headers: {
    "Content-Type": "application/json",
  },
  body: JSON.stringify(data),
});

// axios
axios.defaults.withCredentials = true;
```

---

## 📚 推荐学习资源

| 资源                 | 链接                         |
| -------------------- | ---------------------------- |
| MDN HTTP             | developer.mozilla.org        |
| OWASP                | owasp.org                    |
| Web Security Academy | portswigger.net/web-security |

---
