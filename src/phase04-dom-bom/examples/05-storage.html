<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æœ¬åœ°å­˜å‚¨</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      h1 {
        text-align: center;
        color: #333;
      }
      h2 {
        color: #667eea;
        margin-top: 30px;
        border-bottom: 2px solid #667eea;
        padding-bottom: 8px;
      }
      .demo {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin: 15px 0;
      }
      pre {
        background: #2d2d2d;
        color: #f8f8f2;
        padding: 12px;
        border-radius: 6px;
        overflow-x: auto;
        font-size: 13px;
      }
      button {
        padding: 8px 16px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #5a6fd6;
      }
      button.danger {
        background: #dc3545;
      }
      .output {
        background: #f0f0f0;
        padding: 15px;
        border-radius: 6px;
        margin-top: 10px;
        font-family: monospace;
        max-height: 200px;
        overflow-y: auto;
      }
      input,
      textarea {
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        width: 100%;
        margin: 5px 0;
        box-sizing: border-box;
      }
      input:focus,
      textarea:focus {
        border-color: #667eea;
        outline: none;
      }
      .storage-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: #f8f9fa;
        margin: 5px 0;
        border-radius: 6px;
      }
      .storage-item .key {
        font-weight: bold;
        color: #667eea;
      }
      .storage-item .value {
        color: #666;
        flex: 1;
        margin: 0 15px;
        word-break: break-all;
      }
      .note {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border-left: 4px solid #667eea;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0;
      }
      th,
      td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        background: #f8f9fa;
      }
      .theme-preview {
        padding: 30px;
        border-radius: 8px;
        text-align: center;
        font-size: 18px;
        transition: all 0.3s;
      }
      .theme-light {
        background: #fff;
        color: #333;
        border: 2px solid #ddd;
      }
      .theme-dark {
        background: #2d2d2d;
        color: #f8f8f2;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ’¾ æœ¬åœ°å­˜å‚¨</h1>

    <!-- localStorage vs sessionStorage -->
    <h2>1. localStorage vs sessionStorage</h2>
    <div class="demo">
      <table>
        <tr>
          <th>ç‰¹æ€§</th>
          <th>localStorage</th>
          <th>sessionStorage</th>
        </tr>
        <tr>
          <td>ç”Ÿå‘½å‘¨æœŸ</td>
          <td>æ°¸ä¹…å­˜å‚¨ (é™¤éæ‰‹åŠ¨æ¸…é™¤)</td>
          <td>å…³é—­æ ‡ç­¾é¡µåæ¸…é™¤</td>
        </tr>
        <tr>
          <td>ä½œç”¨åŸŸ</td>
          <td>åŒæºæ‰€æœ‰æ ‡ç­¾é¡µå…±äº«</td>
          <td>ä»…å½“å‰æ ‡ç­¾é¡µ</td>
        </tr>
        <tr>
          <td>å®¹é‡</td>
          <td colspan="2">çº¦ 5MB</td>
        </tr>
        <tr>
          <td>æ•°æ®ç±»å‹</td>
          <td colspan="2">åªèƒ½å­˜å‚¨å­—ç¬¦ä¸²</td>
        </tr>
      </table>
    </div>

    <!-- åŸºæœ¬ API -->
    <h2>2. åŸºæœ¬ API</h2>
    <div class="demo">
      <pre>
// å­˜å‚¨
localStorage.setItem('key', 'value');
sessionStorage.setItem('key', 'value');

// è¯»å–
const value = localStorage.getItem('key');

// åˆ é™¤
localStorage.removeItem('key');

// æ¸…ç©ºæ‰€æœ‰
localStorage.clear();

// è·å–å­˜å‚¨é¡¹æ•°é‡
localStorage.length;

// è·å–ç¬¬ n ä¸ªé”®å
localStorage.key(0);</pre
      >
      <div style="display: flex; gap: 10px; margin-bottom: 10px">
        <input
          type="text"
          id="keyInput"
          placeholder="é”® (key)"
          style="flex: 1"
        />
        <input
          type="text"
          id="valueInput"
          placeholder="å€¼ (value)"
          style="flex: 2"
        />
      </div>
      <button onclick="saveToLocal()">å­˜å…¥ localStorage</button>
      <button onclick="saveToSession()">å­˜å…¥ sessionStorage</button>
      <button onclick="loadStorage()">æŸ¥çœ‹å­˜å‚¨</button>
      <button onclick="clearAll()" class="danger">æ¸…ç©ºæ‰€æœ‰</button>
      <div class="output" id="output2"></div>
    </div>

    <!-- å­˜å‚¨å¯¹è±¡å’Œæ•°ç»„ -->
    <h2>3. å­˜å‚¨å¯¹è±¡å’Œæ•°ç»„ (JSON)</h2>
    <div class="demo">
      <pre>
// å­˜å‚¨å¯¹è±¡
const user = { name: 'å¼ ä¸‰', age: 25 };
localStorage.setItem('user', JSON.stringify(user));

// è¯»å–å¯¹è±¡
const stored = JSON.parse(localStorage.getItem('user'));</pre
      >
      <textarea
        id="jsonInput"
        rows="4"
        placeholder='è¾“å…¥ JSON å¯¹è±¡ï¼Œä¾‹å¦‚: {"name": "å¼ ä¸‰", "age": 25}'
      ></textarea>
      <button onclick="saveJson()">ä¿å­˜ JSON</button>
      <button onclick="loadJson()">è¯»å– JSON</button>
      <div class="output" id="output3"></div>
    </div>

    <!-- å®é™…åº”ç”¨ï¼šä¸»é¢˜åˆ‡æ¢ -->
    <h2>4. å®é™…åº”ç”¨ï¼šä¸»é¢˜åˆ‡æ¢ (æŒä¹…åŒ–)</h2>
    <div class="demo">
      <div class="theme-preview" id="themePreview">ä¸»é¢˜é¢„è§ˆåŒºåŸŸ</div>
      <br />
      <button onclick="setTheme('light')">â˜€ï¸ æµ…è‰²ä¸»é¢˜</button>
      <button onclick="setTheme('dark')">ğŸŒ™ æ·±è‰²ä¸»é¢˜</button>
      <p style="color: #666; margin-top: 10px">åˆ·æ–°é¡µé¢åä¸»é¢˜ä»ä¼šä¿æŒ</p>
    </div>

    <!-- å®é™…åº”ç”¨ï¼šè¡¨å•è‡ªåŠ¨ä¿å­˜ -->
    <h2>5. å®é™…åº”ç”¨ï¼šè¡¨å•è‡ªåŠ¨ä¿å­˜</h2>
    <div class="demo">
      <div class="note">
        åœ¨ä¸‹æ–¹è¾“å…¥å†…å®¹ï¼Œæ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜åˆ° localStorageã€‚åˆ·æ–°é¡µé¢åå†…å®¹ä»åœ¨ï¼
      </div>
      <input
        type="text"
        id="draftTitle"
        placeholder="æ ‡é¢˜"
        onInput="saveDraft()"
      />
      <textarea
        id="draftContent"
        rows="4"
        placeholder="å†…å®¹..."
        onInput="saveDraft()"
      ></textarea>
      <button onclick="clearDraft()" class="danger">æ¸…ç©ºè‰ç¨¿</button>
      <span id="draftStatus" style="color: #28a745; margin-left: 10px"></span>
    </div>

    <!-- storage äº‹ä»¶ -->
    <h2>6. storage äº‹ä»¶ (è·¨æ ‡ç­¾é¡µé€šä¿¡)</h2>
    <div class="demo">
      <pre>
// å½“å…¶ä»–æ ‡ç­¾é¡µä¿®æ”¹ localStorage æ—¶è§¦å‘
window.addEventListener('storage', (e) => {
    console.log('Key:', e.key);
    console.log('æ—§å€¼:', e.oldValue);
    console.log('æ–°å€¼:', e.newValue);
    console.log('URL:', e.url);
});</pre
      >
      <p>
        æ‰“å¼€æ­¤é¡µé¢çš„å¦ä¸€ä¸ªæ ‡ç­¾é¡µï¼Œåœ¨ä¸€ä¸ªæ ‡ç­¾é¡µä¸­ä¿®æ”¹å­˜å‚¨ï¼Œå¦ä¸€ä¸ªä¼šæ”¶åˆ°é€šçŸ¥ã€‚
      </p>
      <button onclick="triggerStorageEvent()">è§¦å‘å­˜å‚¨å˜åŒ–</button>
      <div class="output" id="output6">ç­‰å¾…å…¶ä»–æ ‡ç­¾é¡µçš„å­˜å‚¨å˜åŒ–...</div>
    </div>

    <!-- å­˜å‚¨å°è£…å·¥å…· -->
    <h2>7. å­˜å‚¨å·¥å…·å°è£…</h2>
    <div class="demo">
      <pre>
const storage = {
    set(key, value, expires) {
        const data = {
            value,
            expires: expires ? Date.now() + expires : null
        };
        localStorage.setItem(key, JSON.stringify(data));
    },
    
    get(key) {
        const item = localStorage.getItem(key);
        if (!item) return null;
        
        const data = JSON.parse(item);
        if (data.expires && Date.now() > data.expires) {
            localStorage.removeItem(key);
            return null;
        }
        return data.value;
    },
    
    remove(key) {
        localStorage.removeItem(key);
    }
};</pre
      >
      <button onclick="demo7a()">å­˜å‚¨ (5ç§’è¿‡æœŸ)</button>
      <button onclick="demo7b()">è¯»å–</button>
      <div class="output" id="output7"></div>
    </div>

    <script>
      // å·¥å…·å‡½æ•°
      function log(id, content) {
        document.getElementById(id).innerHTML = content;
      }

      // 2. åŸºæœ¬ API
      function saveToLocal() {
        const key = document.getElementById("keyInput").value.trim();
        const value = document.getElementById("valueInput").value;
        if (!key) return alert("è¯·è¾“å…¥é”®å");
        localStorage.setItem(key, value);
        loadStorage();
      }

      function saveToSession() {
        const key = document.getElementById("keyInput").value.trim();
        const value = document.getElementById("valueInput").value;
        if (!key) return alert("è¯·è¾“å…¥é”®å");
        sessionStorage.setItem(key, value);
        loadStorage();
      }

      function loadStorage() {
        let html = "<strong>localStorage:</strong><br>";
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          const value = localStorage.getItem(key);
          html += `<div class="storage-item">
                    <span class="key">${key}</span>
                    <span class="value">${value.substring(0, 50)}${value.length > 50 ? "..." : ""}</span>
                    <button onclick="removeItem('local', '${key}')">åˆ é™¤</button>
                </div>`;
        }

        html += "<br><strong>sessionStorage:</strong><br>";
        for (let i = 0; i < sessionStorage.length; i++) {
          const key = sessionStorage.key(i);
          const value = sessionStorage.getItem(key);
          html += `<div class="storage-item">
                    <span class="key">${key}</span>
                    <span class="value">${value.substring(0, 50)}${value.length > 50 ? "..." : ""}</span>
                    <button onclick="removeItem('session', '${key}')">åˆ é™¤</button>
                </div>`;
        }

        log("output2", html);
      }

      function removeItem(type, key) {
        if (type === "local") {
          localStorage.removeItem(key);
        } else {
          sessionStorage.removeItem(key);
        }
        loadStorage();
      }

      function clearAll() {
        if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å­˜å‚¨å—ï¼Ÿ")) {
          localStorage.clear();
          sessionStorage.clear();
          loadStorage();
        }
      }

      // 3. JSON å­˜å‚¨
      function saveJson() {
        const input = document.getElementById("jsonInput").value.trim();
        try {
          const obj = JSON.parse(input);
          localStorage.setItem("jsonDemo", JSON.stringify(obj));
          log("output3", "ä¿å­˜æˆåŠŸ: " + JSON.stringify(obj, null, 2));
        } catch (e) {
          log("output3", "é”™è¯¯: æ— æ•ˆçš„ JSON æ ¼å¼");
        }
      }

      function loadJson() {
        const stored = localStorage.getItem("jsonDemo");
        if (stored) {
          const obj = JSON.parse(stored);
          log(
            "output3",
            "è¯»å–æˆåŠŸ:<br><pre>" + JSON.stringify(obj, null, 2) + "</pre>",
          );
        } else {
          log("output3", "æ²¡æœ‰å­˜å‚¨çš„ JSON æ•°æ®");
        }
      }

      // 4. ä¸»é¢˜åˆ‡æ¢
      function setTheme(theme) {
        const preview = document.getElementById("themePreview");
        preview.className = "theme-preview theme-" + theme;
        preview.textContent = theme === "dark" ? "ğŸŒ™ æ·±è‰²ä¸»é¢˜" : "â˜€ï¸ æµ…è‰²ä¸»é¢˜";
        localStorage.setItem("theme", theme);
      }

      // åˆå§‹åŒ–ä¸»é¢˜
      (function initTheme() {
        const savedTheme = localStorage.getItem("theme") || "light";
        setTheme(savedTheme);
      })();

      // 5. è¡¨å•è‡ªåŠ¨ä¿å­˜
      function saveDraft() {
        const draft = {
          title: document.getElementById("draftTitle").value,
          content: document.getElementById("draftContent").value,
          savedAt: new Date().toLocaleTimeString(),
        };
        localStorage.setItem("draft", JSON.stringify(draft));
        document.getElementById("draftStatus").textContent =
          "å·²è‡ªåŠ¨ä¿å­˜ " + draft.savedAt;
      }

      function loadDraft() {
        const saved = localStorage.getItem("draft");
        if (saved) {
          const draft = JSON.parse(saved);
          document.getElementById("draftTitle").value = draft.title || "";
          document.getElementById("draftContent").value = draft.content || "";
          if (draft.savedAt) {
            document.getElementById("draftStatus").textContent =
              "ä¸Šæ¬¡ä¿å­˜ " + draft.savedAt;
          }
        }
      }

      function clearDraft() {
        localStorage.removeItem("draft");
        document.getElementById("draftTitle").value = "";
        document.getElementById("draftContent").value = "";
        document.getElementById("draftStatus").textContent = "è‰ç¨¿å·²æ¸…ç©º";
      }

      // åˆå§‹åŒ–åŠ è½½è‰ç¨¿
      loadDraft();

      // 6. storage äº‹ä»¶
      window.addEventListener("storage", (e) => {
        log(
          "output6",
          `
                <strong>æ£€æµ‹åˆ°å­˜å‚¨å˜åŒ–:</strong><br>
                Key: ${e.key}<br>
                æ—§å€¼: ${e.oldValue}<br>
                æ–°å€¼: ${e.newValue}<br>
                URL: ${e.url}<br>
                æ—¶é—´: ${new Date().toLocaleTimeString()}
            `,
        );
      });

      function triggerStorageEvent() {
        localStorage.setItem("broadcast", Date.now().toString());
        log("output6", "å·²è§¦å‘å­˜å‚¨å˜åŒ–ï¼Œåœ¨å…¶ä»–æ ‡ç­¾é¡µä¸­ä¼šæ”¶åˆ°é€šçŸ¥");
      }

      // 7. å­˜å‚¨å·¥å…·å°è£…
      const storage = {
        set(key, value, expires) {
          const data = {
            value,
            expires: expires ? Date.now() + expires : null,
          };
          localStorage.setItem(key, JSON.stringify(data));
        },

        get(key) {
          const item = localStorage.getItem(key);
          if (!item) return null;

          try {
            const data = JSON.parse(item);
            if (data.expires && Date.now() > data.expires) {
              localStorage.removeItem(key);
              return null;
            }
            return data.value;
          } catch {
            return item;
          }
        },

        remove(key) {
          localStorage.removeItem(key);
        },
      };

      function demo7a() {
        storage.set(
          "tempData",
          { message: "Hello!", time: new Date().toLocaleTimeString() },
          5000,
        );
        log("output7", "å·²å­˜å‚¨æ•°æ®ï¼Œ5ç§’åè¿‡æœŸ");
      }

      function demo7b() {
        const data = storage.get("tempData");
        if (data) {
          log("output7", "è¯»å–æˆåŠŸ: " + JSON.stringify(data));
        } else {
          log("output7", "æ•°æ®ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ");
        }
      }

      // åˆå§‹åŠ è½½å­˜å‚¨å†…å®¹
      loadStorage();
    </script>
  </body>
</html>
